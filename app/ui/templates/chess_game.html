<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Combat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/css/chessboard.min.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        #board { width: 400px; margin-bottom: 1em; }
        .controls { margin-bottom: 1em; }
        .controls label { 
            display: inline-block; 
            margin-right: 15px; 
            margin-bottom: 10px;
            vertical-align: top;
        }
        .controls select {
            margin-left: 5px;
        }
        .controls input[type="checkbox"] { 
            margin-right: 5px; 
        }
        #start-game-btn {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        #start-game-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Chess Combat</h1>
    <form id="new-game-form" class="controls" action="javascript:void(0);" method="post">
        <label>Game Mode:
            <select id="game-mode" name="game_mode">
                <option value="human-vs-ai">Human vs AI</option>
                <option value="ai-vs-ai">AI vs AI</option>
            </select>
        </label>
        <label id="color-label">Your Color:
            <select id="player-color" name="player_color">
                <option value="white">White</option>
                <option value="black">Black</option>
            </select>
        </label>
        <label id="ai-selection-label">AI Engine:
            <select id="ai-engine" name="ai_engine">
                <option value="random">Random Moves</option>
                <option value="openai">ChatGPT (OpenAI)</option>
                <option value="gemini">Gemini (Google)</option>
            </select>
        </label>
        <label>
            <input type="checkbox" id="enforce-rules" checked> Enforce Chess Rules
        </label>
        <button type="button" id="start-game-btn">Start New Game</button>
    </form>
    <div id="board"></div>
    <div id="move-history"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/static/js/chessboard.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - initializing chess game');
        
        let board = null;
        let game = new Chess();
        let gameId = null;
        let gameMode = 'human-vs-ai';
        let playerColor = 'white';
        let enforceRules = true;
        let aiEngine = 'random';

        console.log('jQuery loaded:', typeof $ !== 'undefined');
        console.log('Chess.js loaded:', typeof Chess !== 'undefined');
        console.log('ChessBoard.js loaded:', typeof Chessboard !== 'undefined');

        if (typeof $ === 'undefined') {
            console.error('jQuery failed to load');
            alert('jQuery library failed to load. Please refresh the page.');
            return;
        }

        if (typeof Chess === 'undefined') {
            console.error('Chess.js failed to load');
            alert('Chess.js library failed to load. Please refresh the page.');
            return;
        }

        if (typeof Chessboard === 'undefined') {
            console.error('ChessBoard.js failed to load');
            alert('ChessBoard.js library failed to load. Please refresh the page.');
            return;
        }

        function updateMoveHistory() {
            const history = game.history({ verbose: true });
            let html = '<h3>Move History</h3><ol>';
            for (const move of history) {
                html += `<li>${move.color === 'w' ? 'White' : 'Black'}: ${move.san}</li>`;
            }
            html += '</ol>';
            document.getElementById('move-history').innerHTML = html;
        }

        async function createNewGame() {
            try {
                const mode = document.getElementById('game-mode').value;
                const color = document.getElementById('player-color').value;
                const engine = document.getElementById('ai-engine').value;
                
                console.log('Creating new game with mode:', mode, 'color:', color, 'AI engine:', engine);
                
                const res = await fetch('/api/new-game', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        mode: mode, 
                        color: color, 
                        enforce_rules: enforceRules,
                        ai_engine: engine
                    })
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('Game created:', data);
                
                gameId = data.game_id;
                gameMode = mode;
                playerColor = color;
                aiEngine = engine;
                
                game = new Chess(data.fen);
                board.orientation(color);
                board.position(data.fen);
                updateMoveHistory();
                
                console.log('Game setup complete');
                
                // If it's AI vs AI mode, start the auto-play
                if (gameMode === 'ai-vs-ai') {
                    setTimeout(() => {
                        makeAIMove();
                    }, 1000); // Wait 1 second then start AI moves
                }
            } catch (error) {
                console.error('Error creating new game:', error);
                alert('Failed to create new game: ' + error.message);
            }
        }

        async function makeAIMove() {
            if (!gameId || gameMode !== 'ai-vs-ai') return;
            
            try {
                const res = await fetch('/api/ai-move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        game_id: gameId, 
                        enforce_rules: enforceRules,
                        ai_engine: aiEngine
                    })
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('AI move response:', data);
                
                if (data.ai_move) {
                    if (enforceRules) {
                        game.load(data.fen);
                    } else {
                        try {
                            game.load(data.fen);
                        } catch (e) {
                            console.log('Invalid FEN for AI move when rules disabled');
                        }
                    }
                    board.position(data.fen);
                    updateMoveHistory();
                    
                    // Continue the AI vs AI game with a delay
                    setTimeout(() => {
                        makeAIMove();
                    }, 1500); // Wait 1.5 seconds between moves
                }
            } catch (error) {
                console.error('Error making AI move:', error);
            }
        }

        async function sendMoveToBackend(source, target) {
            if (!gameId) return;
            const move = source + target;
            const res = await fetch('/api/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    game_id: gameId, 
                    move: move,
                    enforce_rules: enforceRules,
                    ai_engine: aiEngine
                })
            });
            const data = await res.json();
            if (data.status && data.status.startsWith('invalid')) {
                // Invalid move, revert
                return 'snapback';
            }
            
            // Update the board position
            if (enforceRules) {
                game.load(data.fen);
            } else {
                // When rules are disabled, we can't rely on chess.js to validate the FEN
                // So we'll just update the visual board without validating
                try {
                    game.load(data.fen);
                } catch (e) {
                    console.log('Invalid FEN when rules disabled, updating board anyway');
                }
            }
            board.position(data.fen);
            updateMoveHistory();
            
            // If AI moved, show it
            if (data.ai_move) {
                setTimeout(() => {
                    if (enforceRules) {
                        game.load(data.fen);
                    } else {
                        try {
                            game.load(data.fen);
                        } catch (e) {
                            console.log('Invalid FEN for AI move when rules disabled');
                        }
                    }
                    board.position(data.fen);
                    updateMoveHistory();
                }, 500);
            }
        }

        function onDragStart (source, piece, position, orientation) {
            if (gameMode === 'ai-vs-ai') return false;
            if ((game.turn() === 'w' && playerColor !== 'white') || (game.turn() === 'b' && playerColor !== 'black')) return false;
            if (enforceRules && game.game_over()) return false;
        }

        async function onDrop (source, target) {
            // Only allow moves if game is active
            if (!gameId) return 'snapback';
            
            // If rules are enforced, validate the move with chess.js
            if (enforceRules) {
                const move = game.move({ from: source, to: target, promotion: 'q' });
                if (move === null) return 'snapback';
            }
            
            // Send move to backend
            const result = await sendMoveToBackend(source, target);
            if (result === 'snapback') {
                if (enforceRules) {
                    game.undo();
                }
                return 'snapback';
            }
        }

        function onSnapEnd () {
            board.position(game.fen());
        }

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd
        });
        
        console.log('ChessBoard initialized:', board);

        document.getElementById('game-mode').addEventListener('change', function() {
            gameMode = this.value;
            console.log('Game mode changed to:', gameMode);
            const isHumanVsAI = (gameMode === 'human-vs-ai');
            document.getElementById('color-label').style.display = isHumanVsAI ? 'inline-block' : 'none';
            document.getElementById('ai-selection-label').style.display = 'inline-block'; // Always show AI selection
        });
        document.getElementById('player-color').addEventListener('change', function() {
            playerColor = this.value;
            console.log('Player color changed to:', playerColor);
        });
        document.getElementById('ai-engine').addEventListener('change', function() {
            aiEngine = this.value;
            console.log('AI engine changed to:', aiEngine);
        });
        document.getElementById('enforce-rules').addEventListener('change', function() {
            enforceRules = this.checked;
            console.log('Enforce rules changed to:', enforceRules);
        });
        document.getElementById('start-game-btn').addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Start game button clicked');
            createNewGame();
        });
        
        console.log('Event listeners attached');
        updateMoveHistory();
    });
    </script>
</body>
</html>
